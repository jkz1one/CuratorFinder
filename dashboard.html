<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Curator Finder Dashboard</title>
<style>
  :root {
    --bg:#0b0b0c;
    --card:#141416;
    --muted:#7e7e86;
    --text:#f2f2f6;
    --accent:#7c5cff;
    --ok:#23c552;
    --warn:#ffb020;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto
  }
  a{color:#cfd0ff}
  header{
    padding:18px 20px;
    border-bottom:1px solid #1e1f24;
    background:linear-gradient(180deg,#13131a,transparent)
  }
  h1{margin:0;font-size:18px}
  .wrap{max-width:1150px;margin:18px auto;padding:0 16px}
  .toolbar{
    display:grid;
    grid-template-columns:repeat(12,1fr);
    gap:10px;
    margin:12px 0
  }
  .toolbar input,.toolbar textarea,.toolbar select{width:100%}
  .toolbar textarea{min-height:60px;resize:vertical}
  .toolbar label{
    display:block;
    font-size:12px;
    color:var(--muted);
    margin-bottom:2px
  }
  .section-title{
    font-size:12px;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:#a5a6b3;
    margin-bottom:6px
  }
  .row{display:flex;align-items:center;gap:8px}
  .row-spread{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .muted{color:var(--muted)}
  .card{
    background:var(--card);
    border-radius:12px;
    padding:14px 14px 12px;
    border:1px solid #202126;
    box-shadow:0 0 0 1px rgba(0,0,0,.4)
  }
  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    border-radius:999px;
    border:1px solid #2f3037;
    background:#18181f;
    color:#f6f6ff;
    font-size:12px;
    padding:6px 12px;
    cursor:pointer;
    gap:6px
  }
  .btn:hover{background:#1e1f26}
  .btn.primary{
    background:linear-gradient(90deg,#3e2fff,#7c5cff);
    border-color:#5b4bff;
    color:#fff
  }
  .btn.primary:hover{filter:brightness(1.05)}
  .btn.small{padding:4px 9px;font-size:11px}
  .btn[disabled]{opacity:.5;cursor:default}
  .btn.copy{border-color:#2c314a}
  .btn.mail{background:#1d2332}
  .btn.link{background:#1a1b24;border-color:#2a2b31;text-decoration:none}
  .btn.link:hover{filter:brightness(1.1)}
  .input{
    background:#101016;
    border-radius:8px;
    border:1px solid #252631;
    color:#f5f5ff;
    padding:6px 8px;
    font-size:13px
  }
  .input::placeholder{color:#4d4e59}
  .input:focus{
    outline:none;
    border-color:#7c5cff;
    box-shadow:0 0 0 1px rgba(124,92,255,0.4)
  }
  .chk-row{
    display:flex;
    align-items:center;
    gap:6px;
    font-size:12px;
    color:var(--muted);
    margin-top:4px
  }
  .chk-row input{margin:0}

  /* MAIN CARDS GRID – behaves like v2: 1-up mobile, 2-up desktop */
  .cards{
    display:grid;
    grid-template-columns:repeat(12,1fr);
    gap:12px;
    margin:10px 0 40px;
  }

  .curator-card{
    background:var(--card);
    border-radius:12px;
    padding:10px 10px 9px;
    border:1px solid #22222b;
    display:flex;
    flex-direction:column;
    gap:6px;
    grid-column:span 12;
  }
  @media (min-width:900px){
    .curator-card{grid-column:span 6;}
  }

  .curator-title{
    font-weight:600;
    font-size:13px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:6px
  }
  .pill{
    display:inline-flex;
    align-items:center;
    border-radius:999px;
    padding:4px 8px;
    font-size:10px;
    border:1px solid #2f3040;
    color:#cfd0ff;
    background:#181822;
    white-space:nowrap
  }
  .pill-owner{font-size:11px;color:#b5b6c6}
  .pill-email{
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    font-size:11px
  }
  .pill-badge{
    font-size:10px;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:#a7a8ff
  }
  .pill-link{
    font-size:11px;
    color:#d5d6ff;
    max-width:100%;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap
  }
  .pill.ok{border-color:#224a2e;background:#0f1b12;color:#ccf2d5}
  .pill.warn{border-color:#4a3b22;background:#1b160f;color:#ffe3b5}
  .stat{font-size:11px;color:#a1a2b3}
  .stat strong{color:#f5f5ff}
  .badge{
    padding:3px 8px;
    border-radius:999px;
    border:1px solid #2b2c33;
    background:#111118;
    color:#cfd0d8;
    font-size:11px
  }
  .badge.ok{border-color:#224a2e;background:#0f1b12;color:#ccf2d5}
  .badge.err{border-color:#4a2e2e;background:#1b0f0f;color:#f2c2c2}

  /* Progress bar next to Run Search */
  .run-bar { display:none; align-items:center; gap:8px; }
  .run-bar.on { display:flex; }
  .run-bar .bar {
    position:relative; width:200px; height:8px; border-radius:999px;
    background:#1b1c22; overflow:hidden; border:1px solid #2a2b31;
  }
  .run-bar .fill {
    position:absolute; left:0; top:0; bottom:0; width:0%;
    background: linear-gradient(90deg, #3e2fff, #7c5cff);
    transition: width .25s ease;
  }

  .beta-banner {
    background: linear-gradient(90deg, #252033, #171721);
    color: #e7e3ff;
    text-align: center;
    padding: 6px 12px;
    font-size: 11px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    border-bottom: 1px solid #26263a;
  }

  /* Modal overlay + card (used by Beta + Settings) */
  .modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.45);
    z-index: 40;
  }
  .modal-card {
    background: var(--card);
    border-radius: 12px;
    border: 1px solid #262733;
    padding: 16px 18px 14px;
    max-width: 420px;
    width: calc(100% - 40px);
    box-shadow: 0 18px 45px rgba(0,0,0,0.7);
    margin: auto;
  }

  /* Table-style contact grid inside each curator card */
  .grid{
    width:100%;
    border-collapse:collapse;
    margin-top:4px;
    font-size:11px
  }
  .grid th,.grid td{
    border-top:1px solid #22232a;
    padding:6px 4px;
    vertical-align:top
  }
  .grid th{
    font-weight:500;
    color:#b4b5c5;
    text-align:left
  }
  .row-actions{
    display:flex;
    flex-wrap:wrap;
    gap:6px
  }
</style>
</head>
<body>
<div class="beta-banner">Early Access Preview</div>
<header class="wrap">
  <div class="row-spread">
    <div>
      <h1 style="margin:0;font-size:18px">Curator Finder Dashboard</h1>
      <div class="muted">Upload <code>curators.json</code> or run a new search via your local server.</div>
    </div>
    <div class="row" style="flex-wrap:wrap;gap:8px">
      <span id="svr" class="badge">Server</span>
      <span id="sp"  class="badge">Spotify</span>
      <span id="beta" class="badge">Early Access</span>
      <span id="ver" class="muted"></span>
      <button id="openSettings" class="btn small" title="Save Spotify keys">Settings</button>
      <button id="manageBeta" class="btn small" title="View beta status">Beta Info</button>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- Controls -->
  <div class="toolbar">
    <div style="grid-column:span 12">
      <div class="section-title">Load existing results</div>
      <input id="file" type="file" accept=".json" />
    </div>

    <div class="sep" style="grid-column:span 12"></div>

    <div style="grid-column:span 12">
      <div class="section-title">Run a new search</div>
    </div>
    <input id="artists"  style="grid-column:span 6" class="input" placeholder="Artists (comma separated)" />
    <input id="keywords" style="grid-column:span 6" class="input" placeholder="Keywords (comma separated)" />
    <input id="genres"   style="grid-column:span 6" class="input" placeholder="Genres (comma separated)" />
    <div style="grid-column:span 3">
      <label>Target emails</label>
      <input id="target" class="input" type="number" min="10" max="1000" step="10" value="100" />
    </div>
    <div style="grid-column:span 3;display:flex;align-items:flex-end;justify-content:flex-start;gap:8px">
      <button id="runSearch" class="btn primary">Run Search</button>
      <div id="runBar" class="run-bar">
        <div class="bar"><div class="fill" id="runFill"></div></div>
        <span id="runMeta" class="muted" style="font-size:11px"></span>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card" style="margin-bottom:14px">
    <div class="row-spread" style="margin-bottom:8px">
      <div class="section-title" style="margin:0">Filter results</div>
      <input id="filter" class="input" style="max-width:260px" placeholder="Filter by playlist, owner, email, contact link…" />
    </div>
    <div class="row" style="flex-wrap:wrap;gap:10px;margin-top:4px">
      <label class="chk-row"><input id="showOwnerLinks" type="checkbox" checked />Show owner links</label>
      <label class="chk-row"><input id="showContactLinks" type="checkbox" checked />Show contact links</label>
      <label class="chk-row"><input id="hideContacted" type="checkbox" />Hide contacted</label>
      <label class="chk-row">
        <span>Contact type:</span>
        <select id="filterHas" class="input" style="width:auto;min-width:140px">
          <option value="any">Any</option>
          <option value="email">Has email</option>
          <option value="link">Has submission link</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Results -->
  <div class="card">
    <div class="row-spread">
      <div class="section-title" style="margin:0">Curators</div>
      <div class="row" style="gap:8px">
        <button id="clearContacted" class="btn small">Clear contacted</button>
        <button id="exportCsv" class="btn small">Export CSV</button>
      </div>
    </div>
    <div id="stats" class="muted" style="margin:8px 0 14px"></div>
    <div id="list" class="cards"></div>
  </div>

  <!-- Early Access / Beta modal -->
  <div id="betaModal" class="modal">
    <div class="modal-card">
      <div class="row-spread" style="margin-bottom:8px">
        <h3 style="margin:0">Early Access / Beta Info</h3>
        <button id="betaClose" class="btn small">Close</button>
      </div>
      <p id="betaStatus" class="muted" style="font-size:13px;margin-top:4px;margin-bottom:0">
        Loading…
      </p>
    </div>
  </div>

  <!-- Settings modal (Spotify keys) -->
  <div id="settingsModal" class="modal">
    <div class="modal-card">
      <div class="row-spread" style="margin-bottom:8px">
        <h3 style="margin:0">Settings</h3>
        <button id="settingsClose" class="btn small">Close</button>
      </div>
      <p class="muted" style="margin-top:0">Saved to <code>~/.curator-finder/config.json</code>.</p>

      <div class="section-title">Spotify Credentials</div>
      <input id="setupClientId" class="input" type="text" placeholder="Spotify Client ID" autocomplete="off" />
      <input id="setupClientSecret" class="input" type="password" placeholder="Spotify Client Secret" autocomplete="off" />

      <div class="row" style="justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="settingsSave" class="btn primary">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ----------------- Running state ----------------- */
function setRunning(on, msg){
  const btn = document.getElementById('runSearch');
  const bar = document.getElementById('runBar');
  const fill = document.getElementById('runFill');
  const meta = document.getElementById('runMeta');
  if(on){
    if (btn) btn.disabled = true;
    if (bar) bar.classList.add('on');
    if (meta) meta.textContent = msg || 'Starting…';
    if (fill) fill.style.width = '10%';
  }else{
    if (btn) btn.disabled = false;
    if (bar){
      setTimeout(()=>bar.classList.remove('on'), 400);
    }
  }
}

/* ----------------- Simple helpers ----------------- */
function $(sel){ return document.querySelector(sel); }
function badge(el, ok, label){
  if(!el) return;
  el.textContent = label;
  el.classList.remove('ok','err');
  el.classList.add(ok ? 'ok' : 'err');
}
function fmtDate(ts){
  if(!ts) return "";
  const d = new Date(ts*1000);
  return d.toLocaleDateString();
}
async function refreshStatus(){
  try{
    const r = await fetch('/health', {cache:'no-store'});
    const h = await r.json();
    const beta = h.beta || {};
    badge($('#svr'), true, 'Server OK');
    badge($('#sp'),  h.spotify.configured, h.spotify.configured ? 'Spotify OK' : 'Spotify Missing');
    const betaMode = beta.mode || 'enabled';
    const betaOk = betaMode === 'disabled' ? true : !!beta.ok;
    let betaLbl;
    if (betaMode === 'disabled') {
      betaLbl = 'Early Access Off';
    } else if (betaOk) {
      betaLbl = 'Early Access OK';
      if (typeof beta.expires_at === 'number') {
        betaLbl += ' (exp ' + fmtDate(beta.expires_at) + ')';
      }
    } else {
      betaLbl = 'Early Access Error';
    }
    badge($('#beta'), betaOk, betaLbl);
    $('#ver').textContent = 'v' + h.version;

    // Auto-open Settings modal first time if Spotify missing
    if (!h.spotify.configured && !window._settingsPrompted) {
      window._settingsPrompted = true;
      showSettingsModal();
    }
  }catch(e){
    badge($('#svr'), false, 'Server Down');
    badge($('#sp'),  false, 'Spotify Unknown');
    badge($('#beta'), false, 'Early Access Unknown');
  }
}

async function showSettingsModal(){
  try{
    const r = await fetch('/config', {cache:'no-store'});
    if (!r.ok) throw new Error('Failed to load config');
    const c = await r.json();
    if (c.client_id_masked){
      $('#setupClientId').placeholder = 'Configured ('+c.client_id_masked+')';
    }
    if (c.client_secret_set){
      $('#setupClientSecret').placeholder = 'Configured (saved)';
    }
  }catch(e){
    console.warn('Config load failed:', e);
  }
  $('#settingsModal').style.display = 'block';
}

setInterval(refreshStatus, 3000);
refreshStatus();

/* Early Access / Beta modal behavior */
function showBetaModal(){
  $('#betaModal').style.display = 'block';
  updateBetaModal();
}
function hideBetaModal(){
  $('#betaModal').style.display = 'none';
}
$('#manageBeta').addEventListener('click', showBetaModal);
$('#betaClose').addEventListener('click', hideBetaModal);

async function updateBetaModal(){
  const el = $('#betaStatus');
  el.textContent = 'Loading…';
  try{
    const res = await fetch('/health', {cache:'no-store'});
    const h = await res.json();
    const beta = h.beta || {};
    const mode = beta.mode || 'enabled';
    const ok = mode === 'disabled' ? true : !!beta.ok;
    let msg = `Mode: ${mode}`;
    if (typeof beta.expires_at === 'number') {
      msg += ` • Expires: ${fmtDate(beta.expires_at)}`;
    }
    if (beta.message) {
      msg += ` • Status: ${beta.message}`;
    } else {
      msg += ` • Status: ${ok ? 'OK' : 'error'}`;
    }
    el.textContent = msg;
  }catch(e){
    el.textContent = 'Failed to load beta status.';
  }
}

/* ---------------- Settings (Spotify keys) ---------------- */
function hideSettingsModal(){ $('#settingsModal').style.display = 'none'; }
$('#openSettings').addEventListener('click', showSettingsModal);
$('#settingsClose').addEventListener('click', hideSettingsModal);

$('#settingsSave').addEventListener('click', async ()=>{
  const client_id = ($('#setupClientId').value || '').trim();
  const client_secret = ($('#setupClientSecret').value || '').trim();

  if (!client_id || !client_secret){
    alert("Enter both Spotify Client ID and Secret.");
    return;
  }
  const btn = $('#settingsSave'); btn.disabled = true; btn.textContent = 'Saving…';
  try{
    const res = await fetch('/setup', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ client_id, client_secret })
    });
    if (!res.ok) {
      let msg = '';
      try { const j = await res.json(); msg = j.detail || JSON.stringify(j); }
      catch { msg = await res.text(); }
      throw new Error(msg);
    }
    hideSettingsModal();
    alert('Saved! You can now run searches.');
    await refreshStatus();
  }catch(e){
    alert('Setup error: ' + (e.message || e));
  }finally{
    btn.disabled = false; btn.textContent = 'Save';
  }
});

/* -------------- Utilities for contacts + filtering -------------- */
function matchesQuery(rec, q){
  if(!q) return true;
  q = q.toLowerCase();

  const pl = rec.playlist || {};
  const owner = rec.owner || {};
  const contacts = rec.contacts || {};
  const emails = (contacts.emails || []).map(e=>e.value || e.email || '').join(" ");
  const subs = (contacts.submissions || []).map(s=>s.url || '').join(" ");

  return (
    (pl.name || "").toLowerCase().includes(q) ||
    (owner.name || "").toLowerCase().includes(q) ||
    emails.toLowerCase().includes(q) ||
    subs.toLowerCase().includes(q)
  );
}
function domainOf(url){
  try{
    const u = new URL(url);
    return u.hostname.replace(/^www\./,'');
  }catch{return '';}
}
function contactLabel(u){
  const d = domainOf(u);
  if (!d) return "Website";
  if (d.includes("instagram.com")) return "Instagram";
  if (d.includes("facebook.com"))  return "Facebook";
  if (d.includes("x.com") || d.includes("twitter.com")) return "X";
  if (d.includes("youtube.com") || d.includes("youtu.be")) return "YouTube";
  if (d.includes("tiktok.com"))   return "TikTok";
  if (d.includes("linktr.ee"))    return "Linktree";
  if (d.includes("beacons.ai"))   return "Beacons";
  if (d.includes("carrd.co"))     return "Carrd";
  if (d.includes("notion.so"))    return "Notion";
  if (d.includes("typeform.com")) return "Typeform";
  if (d.includes("jotform.com"))  return "Jotform";
  if (d.includes("tally.so"))     return "Tally";
  if (d.includes("airtable.com")) return "Airtable";
  return d;
}
function contactType(rec){
  const contacts = rec.contacts || {};
  const emails = contacts.emails || [];
  const subs = contacts.submissions || [];
  return {
    hasEmail: emails.length > 0,
    hasLink: subs.length > 0
  };
}
function mailtoHref(email, curator, playlist){
  const subjBase = `Submission: new track for ${playlist || "your playlist"}`;
  const bodyBase = `Hey ${curator || ""},

I’ve got a new track that fits your playlist "${playlist || ""}".
Short blurb here.
Streaming link: <your link>

Thanks!`;
  const enc = s => encodeURIComponent(s || "");
  const base = `mailto:${enc(email)}?subject=${enc(subjBase)}&body=${enc(bodyBase)}`;
  if (base.length <= 1800) return base;

  let body = bodyBase.slice(0, 1200) + "…";
  let subj = subjBase;
  let href = `mailto:${enc(email)}?subject=${enc(subj)}&body=${enc(body)}`;
  if (href.length <= 1800) return href;

  subj = subjBase.slice(0, 120) + "…";
  href = `mailto:${enc(email)}?subject=${enc(subj)}&body=${enc(body)}`;
  if (href.length <= 1800) return href;

  const minimal = `mailto:${enc(email)}?subject=${enc("Submission inquiry")}`;
  const full = `Subject: ${subjBase}\n\n${bodyBase}`;
  navigator.clipboard?.writeText(full).then(()=>{
    alert("Body was long for mailto. I copied the full message to your clipboard—paste it in your email.");
  }).catch(()=>{});
  return minimal;
}
async function copy(text){
  try{ await navigator.clipboard.writeText(text); }catch(e){ console.log(e); }
}

/* -------------- Global data + contacted tracking -------------- */
let data = [];      // full curator records
let filtered = [];  // filtered view

const contactedStorageKey = 'cf_contacted_v2';
const contactedMap = JSON.parse(localStorage.getItem(contactedStorageKey) || "{}");
function saveContacted(){
  localStorage.setItem(contactedStorageKey, JSON.stringify(contactedMap));
}
function contactedKey(rec){
  const pl = rec.playlist || {};
  const owner = rec.owner || {};
  const contacts = rec.contacts || {};
  const emails = contacts.emails || [];
  const primaryEmail = emails[0]?.value || emails[0]?.email || '';
  return (primaryEmail || owner.id || owner.name || pl.url || '').toLowerCase();
}

/* -------------- Render cards -------------- */
function renderCurators(curators){
  if (curators){
    data = Array.isArray(curators) ? curators : (curators.results || []);
  }
  const list = document.getElementById('list');
  if (!list) return;

  const q = ($('#filter').value || '').trim();
  const hasVal = $('#filterHas').value;
  const hideContacted = $('#hideContacted').checked;
  const showOwner = document.getElementById('showOwnerLinks').checked;
  const showContact = document.getElementById('showContactLinks').checked;

  filtered = data.filter(rec=>{
    if (!matchesQuery(rec, q)) return false;
    const t = contactType(rec);
    if (hasVal === 'email' && !t.hasEmail) return false;
    if (hasVal === 'link' && !t.hasLink) return false;
    if (hideContacted && contactedMap[contactedKey(rec)]) return false;
    return true;
  });

  list.innerHTML = '';

  const totalWithEmail = data.filter(r=>contactType(r).hasEmail).length;
  const totalWithLink  = data.filter(r=>contactType(r).hasLink).length;
  const stats = document.getElementById('stats');
  if (stats){
    stats.textContent = `Showing ${filtered.length} of ${data.length} curators — ` +
      `${totalWithEmail} with email, ${totalWithLink} with submission link`;
  }

  for(const rec of filtered){
    const card = document.createElement('div');
    card.className = 'curator-card';

    const pl = rec.playlist || {};
    const owner = rec.owner || {};
    const contacts = rec.contacts || {};
    const emails = contacts.emails || [];
    const subs = contacts.submissions || [];
    const ownerLinks = owner.links || [];
    const cKey = contactedKey(rec);
    const isContacted = !!contactedMap[cKey];

    // Header row: owner + playlist + counts
    const header = document.createElement('div');
    header.className = 'row-spread';
    header.style.alignItems = 'center';

    const left = document.createElement('div');
    left.style.minWidth = '0';

    const title = document.createElement('div');
    title.className = 'curator-title';

    const nameSpan = document.createElement('span');
    nameSpan.textContent = owner.name || owner.id || '(unknown owner)';
    nameSpan.style.whiteSpace = 'nowrap';
    nameSpan.style.textOverflow = 'ellipsis';
    nameSpan.style.overflow = 'hidden';

    const playlistSpan = document.createElement('span');
    playlistSpan.className = 'muted';
    if (pl.url){
      const a = document.createElement('a');
      a.href = pl.url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.textContent = pl.name || '(playlist)';
      a.style.color = '#cfd0ff';
      a.style.textDecoration = 'none';
      playlistSpan.appendChild(document.createTextNode(' • '));
      playlistSpan.appendChild(a);
    } else {
      playlistSpan.textContent = pl.name ? (' • ' + pl.name) : '';
    }

    nameSpan.appendChild(playlistSpan);
    title.appendChild(nameSpan);

    // Primary email pill
    const emailPill = document.createElement('span');
    emailPill.className = 'pill pill-email';
    emailPill.textContent = emails[0]?.value || emails[0]?.email || '(no email)';
    title.appendChild(emailPill);

    left.appendChild(title);

    // Optional source / extra muted row
    if (rec.source_query){
      const src = document.createElement('div');
      src.className = 'muted';
      src.style.fontSize = '11px';
      src.style.marginTop = '2px';
      src.textContent = rec.source_query;
      left.appendChild(src);
    }

    const right = document.createElement('div');
    right.className = 'row';
    const emailCount = document.createElement('span');
    emailCount.className = 'pill ' + (emails.length ? 'ok' : 'warn');
    emailCount.textContent = emails.length ? (emails.length + ' email' + (emails.length>1?'s':'')) : 'no email';
    const linkCount = document.createElement('span');
    const linkTotal = subs.length + (showOwner ? ownerLinks.length : 0);
    linkCount.className = 'pill';
    linkCount.textContent = linkTotal ? (linkTotal + ' link' + (linkTotal>1?'s':'')) : 'no link';
    right.appendChild(emailCount);
    right.appendChild(linkCount);

    header.appendChild(left);
    header.appendChild(right);
    card.appendChild(header);

    // Contact grid
    const table = document.createElement('table');
    table.className = 'grid';
    table.innerHTML = '<thead><tr><th>Contact</th><th>Context</th><th>Actions</th></tr></thead><tbody></tbody>';
    const tbody = table.querySelector('tbody');

    let rowCount = 0;

    // Email rows
    if (emails.length){
      for(const e of emails){
        const tr = document.createElement('tr');
        const emailVal = e.value || e.email || '';
        tr.innerHTML = `
          <td>${emailVal ? `<code>${emailVal}</code>` : '<span class="muted">—</span>'}</td>
          <td class="muted">${e.context || ''}</td>
          <td class="row-actions"></td>
        `;
        const actions = tr.querySelector('.row-actions');
        if (emailVal){
          const copyBtn = document.createElement('button');
          copyBtn.className = 'btn small copy';
          copyBtn.textContent = 'Copy';
          copyBtn.addEventListener('click', ()=>copy(emailVal));

          const mailA = document.createElement('a');
          mailA.className = 'btn small mail';
          mailA.textContent = 'Mailto';
          mailA.href = mailtoHref(emailVal, owner.name, pl.name);

          actions.append(copyBtn, mailA);
        }
        tbody.appendChild(tr);
        rowCount++;
      }
    }

    // Owner links (if enabled)
    if (showOwner && ownerLinks && ownerLinks.length){
      for(const u of ownerLinks){
        const tr = document.createElement('tr');
        const label = contactLabel(u);
        tr.innerHTML = `
          <td>${label}</td>
          <td class="muted">Owner link</td>
          <td class="row-actions"></td>
        `;
        const actions = tr.querySelector('.row-actions');
        const a = document.createElement('a');
        a.className = 'btn small link';
        a.href = u;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = 'Open';
        actions.appendChild(a);
        tbody.appendChild(tr);
        rowCount++;
      }
    }

    // Submission links (if enabled)
    if (showContact && subs && subs.length){
      for(const s of subs){
        const u = s.url || '';
        if (!u) continue;
        const tr = document.createElement('tr');
        const label = contactLabel(u);
        tr.innerHTML = `
          <td>${label}</td>
          <td class="muted">${s.context || 'Submission link'}</td>
          <td class="row-actions"></td>
        `;
        const actions = tr.querySelector('.row-actions');
        const a = document.createElement('a');
        a.className = 'btn small link';
        a.href = u;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = 'Open';
        actions.appendChild(a);
        tbody.appendChild(tr);
        rowCount++;
      }
    }

    if (!rowCount){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="muted">—</span></td>
        <td class="muted">No contact info found</td>
        <td></td>
      `;
      tbody.appendChild(tr);
    }

    card.appendChild(table);

    // Mark as contacted
    const markWrap = document.createElement('div');
    markWrap.style.marginTop = '8px';
    const label = document.createElement('label');
    label.className = 'chk-row';
    const chk = document.createElement('input');
    chk.type = 'checkbox';
    chk.checked = isContacted;
    chk.addEventListener('change', (ev)=>{
      if (ev.target.checked) contactedMap[cKey] = true;
      else delete contactedMap[cKey];
      saveContacted();
    });
    label.prepend(chk);
    label.appendChild(document.createTextNode('Marked as contacted'));
    markWrap.appendChild(label);
    card.appendChild(markWrap);

    list.appendChild(card);
  }
}

/* -------------- Filter controls wiring -------------- */
document.getElementById('filter').addEventListener('input', ()=>renderCurators());
document.getElementById('showOwnerLinks').addEventListener('change', ()=>renderCurators());
document.getElementById('showContactLinks').addEventListener('change', ()=>renderCurators());
document.getElementById('filterHas').addEventListener('change', ()=>renderCurators());
document.getElementById('hideContacted').addEventListener('change', ()=>renderCurators());

/* -------------- Clear contacted -------------- */
document.getElementById('clearContacted').addEventListener('click', ()=>{
  Object.keys(contactedMap).forEach(k=>delete contactedMap[k]);
  saveContacted();
  renderCurators();
});

/* -------------- Load local curators file -------------- */
document.getElementById('file').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  try{
    const text = await f.text();
    const json = JSON.parse(text);
    // Support both direct array and {results:[...]}
    const arr = Array.isArray(json) ? json : (json.results || []);
    renderCurators(arr);
  }catch(err){
    alert('Failed to parse curators.json: ' + err.message);
  }
});

/* -------------- Run search via server (simple JSON, NO streaming) -------------- */
document.getElementById('runSearch').addEventListener('click', async ()=>{
  const artists = ($('#artists').value || '').split(',').map(s=>s.trim()).filter(Boolean);
  const keywords = ($('#keywords').value || '').split(',').map(s=>s.trim()).filter(Boolean);
  const genres = ($('#genres').value || '').split(',').map(s=>s.trim()).filter(Boolean);
  const target = parseInt($('#target').value || '100', 10) || 100;

  const body = { artists, keywords, genres, target, save:true };

  const statsEl = document.getElementById('stats');
  const fill = $('#runFill');
  const meta = $('#runMeta');

  setRunning(true, 'Running…');
  if (fill) fill.style.width = '20%';
  if (meta) meta.textContent = 'Contacting server…';

  try{
    const res = await fetch('/search', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });

    if (!res.ok){
      let msg = '';
      try { const j = await res.json(); msg = j.detail || JSON.stringify(j); }
      catch { msg = await res.text(); }
      alert('Search error: ' + msg);
      return;
    }

    if (meta) meta.textContent = 'Processing results…';
    if (fill) fill.style.width = '70%';

    const payload = await res.json();

    const count = payload.count_curators ?? 0;
    const emails = payload.unique_emails ?? 0;
    const tgt = body.target ?? 0;

    if (statsEl){
      statsEl.textContent = `Found ${count} curators (${emails} unique emails). Target was ${tgt}.`;
    }
    renderCurators(payload.results || []);

    if (meta) meta.textContent = 'Done';
    if (fill) fill.style.width = '100%';
  }catch(e){
    alert('Search error: ' + (e.message || e));
  }finally{
    setTimeout(()=>setRunning(false), 800);
  }
});

/* -------------- Export CSV -------------- */
document.getElementById('exportCsv').addEventListener('click', ()=>{
  if(!data.length){
    alert('No curators loaded yet. Run a search or load curators.json first.');
    return;
  }
  if(!filtered.length){
    alert('No curators match the current filters.');
    return;
  }

  const rows = [];
  for(const rec of filtered){
    const pl = rec.playlist || {};
    const owner = rec.owner || {};
    const contacts = rec.contacts || {};
    const emails = contacts.emails || [];
    const subs = (contacts.submissions || []).map(s=>s.url || '').filter(Boolean);
    const ownerLinks = (owner.links || []).filter(Boolean);

    const base = {
      curator_name: owner.name || owner.id || '',
      playlist_name: pl.name || '',
      playlist_url: pl.url || '',
      submission_links: subs.join(' | '),
      owner_links: ownerLinks.join(' | '),
      source_query: rec.source_query || '',
      contacted: contactedMap[contactedKey(rec)] ? 'yes' : 'no'
    };

    if (emails.length){
      emails.forEach((e, idx)=>{
        rows.push({
          ...base,
          email: e.value || e.email || '',
          email_context: e.context || '',
          email_index: idx + 1
        });
      });
    }else{
      rows.push({
        ...base,
        email: '',
        email_context: '',
        email_index: ''
      });
    }
  }

  if (!rows.length){
    alert('Nothing to export.');
    return;
  }

  const headers = Object.keys(rows[0]);
  const esc = v => '"' + String(v ?? "").replace(/"/g,'""') + '"';
  const lines = [
    headers.join(','),
    ...rows.map(r => headers.map(h=>esc(r[h])).join(','))
  ];
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'curators_filtered.csv';
  a.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
