<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Curator Finder Dashboard</title>
<style>
  :root { --bg:#0b0b0c; --card:#141416; --muted:#7e7e86; --text:#f2f2f6; --accent:#7c5cff; --ok:#23c552; --warn:#ffb020; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto}
  a{color:#cfd0ff}
  header{padding:18px 20px;border-bottom:1px solid #1e1f24;background:linear-gradient(180deg,#13131a,transparent)}
  h1{margin:0;font-size:18px}
  .wrap{max-width:1150px;margin:18px auto;padding:0 16px}
  .toolbar{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin:12px 0}
  .toolbar > * {min-width:0}
  .toolbar input[type="text"], .toolbar input[type="number"], .toolbar select{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2b31;background:#101015;color:var(--text)
  }
  .toolbar input[type="file"]{color:var(--muted)}
  .toolbar button{padding:10px 12px;border-radius:10px;border:1px solid #2a2b31;background:#17181f;color:var(--text);cursor:pointer}
  .toolbar button.primary{background:var(--accent);border-color:transparent;color:#fff}
  .toolbar label{display:flex;gap:8px;align-items:center;color:var(--muted)}
  .cards{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .card{grid-column:span 12;background:var(--card);border:1px solid #24252b;border-radius:14px;padding:14px}
  @media(min-width:900px){.card{grid-column:span 6}}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid #2b2c33;color:#cfd0d8;background:#111118}
  .pill.ok{border-color:#224a2e;background:#0f1b12;color:#ccf2d5}
  .pill.warn{border-color:#4a3b22;background:#1b160f;color:#ffe3b5}
  .muted{color:var(--muted)}
  .grid{width:100%;border-collapse:collapse;margin-top:8px}
  .grid th,.grid td{border-top:1px solid #22232a;padding:8px 6px;vertical-align:top}
  .btn{padding:6px 10px;border-radius:8px;border:1px solid #2a2b31;background:#17181f;color:#e9e9ef;cursor:pointer}
  .btn.copy{border-color:#2c314a}
  .btn.mail{background:#1d2332}
  .btn.small{padding:4px 8px;font-size:12px}
  .btn.link { background:#1a1b24; border-color:#2a2b31; text-decoration:none }
  .btn.link:hover { filter:brightness(1.1) }
  .row-actions{display:flex;flex-wrap:wrap;gap:8px}
  .section-title{font-weight:600;margin-top:6px;margin-bottom:6px}
  .sep{height:1px;background:#22232a;margin:10px 0}
  .checkbox{accent-color:var(--accent)}
  /* modals */
  .modal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:9999; padding:20px}
  .modal-card{max-width:560px; margin:8vh auto; background:#141416; color:#f2f2f6; border:1px solid #24252b; border-radius:14px; padding:16px}
  .input{width:100%; padding:10px; border-radius:10px; border:1px solid #2a2b31; background:#101015; color:#f2f2f6; margin-bottom:8px}
  .row{display:flex;gap:10px;align-items:center}
  .row-spread{display:flex; gap:10px; align-items:center; justify-content:space-between}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace; background:#0e0f13; border:1px solid #2a2b31; padding:3px 6px; border-radius:6px}
  .badge{padding:3px 8px; border-radius:999px; border:1px solid #2b2c33; background:#111118; color:#cfd0d8}
  .badge.ok{border-color:#224a2e;background:#0f1b12;color:#ccf2d5}
  .badge.err{border-color:#4a2e2e;background:#1b0f0f;color:#f2c2c2}

  /* Progress bar next to Run Search */
  .run-bar { display:none; align-items:center; gap:8px; }
  .run-bar.on { display:flex; }
  .run-bar .bar {
    position:relative; width:200px; height:8px; border-radius:999px;
    background:#1b1c22; overflow:hidden; border:1px solid #2a2b31;
  }
  .run-bar .fill {
    position:absolute; left:0; top:0; bottom:0; width:0%;
    background: linear-gradient(90deg, #3e2fff, #7c5cff);
    transition: width .25s ease;
  }
</style>
</head>
<body>
<header class="wrap">
  <div class="row-spread">
    <div>
      <h1 style="margin:0;font-size:18px">Curator Finder Dashboard</h1>
      <div class="muted">Upload <code>curators.json</code> or run a new search via your local server.</div>
    </div>
    <div class="row" style="flex-wrap:wrap;gap:8px">
      <span id="svr" class="badge">Server</span>
      <span id="sp"  class="badge">Spotify</span>
      <span id="lic" class="badge">License</span>
      <span id="ver" class="muted"></span>
      <button id="openSettings" class="btn small" title="Save Spotify keys">Settings</button>
      <button id="manageLic" class="btn small" title="View device ID and activate">Manage License</button>
    </div>
  </div>
</header>

<div class="wrap">

  <!-- Controls -->
  <div class="toolbar">
    <div style="grid-column:span 12">
      <div class="section-title">Load existing results</div>
      <input id="file" type="file" accept=".json" />
    </div>

    <div class="sep" style="grid-column:span 12"></div>

    <div style="grid-column:span 12">
      <div class="section-title">Run a new search</div>
    </div>
    <input id="artists"  style="grid-column:span 4" type="text" placeholder="Artists (comma-separated)" />
    <input id="keywords" style="grid-column:span 4" type="text" placeholder="Keywords (comma-separated)" />
    <input id="genres"   style="grid-column:span 4" type="text" placeholder="Genres (comma-separated)" />
    <input id="target"   style="grid-column:span 2" type="number" min="1" value="50" title="Unique emails target" />
    <button id="runSearch" class="btn primary" style="grid-column:span 2">Run Search</button>
    <div id="runBar" class="run-bar" style="grid-column:span 4">
      <div class="bar"><div id="runFill" class="fill"></div></div>
      <span class="muted" id="runMsg">Ready</span>
    </div>    
    <div style="grid-column:span 8" class="muted">Tip: keep target modest (e.g., 25–75) for faster responses.</div>

    <div class="sep" style="grid-column:span 12"></div>

    <!-- Filters -->
    <input id="q" style="grid-column:span 4" type="text" placeholder="Search curator / playlist / email" />
    <select id="has" style="grid-column:span 3" title="Filter by contact type">
      <option value="any">Has email or submission link</option>
      <option value="email">Has email</option>
      <option value="link">Has submission link</option>
    </select>
    <div class="row" style="grid-column:span 5;gap:8px;justify-content:flex-end;align-items:center">
      <label><input id="hideContacted" class="checkbox" type="checkbox" /> hide contacted</label>
      <button id="exportCsv" class="btn">Export CSV</button>
      <button id="clearLs" class="btn small">Clear ‘contacted’</button>
    </div>
  </div>

  <div id="stats" class="muted" style="margin:8px 0 14px"></div>
  <div id="list" class="cards"></div>
</div>

<!-- License modal -->
<div id="licModal" class="modal">
  <div class="modal-card">
    <div class="row-spread" style="margin-bottom:8px">
      <h3 style="margin:0">License Manager</h3>
      <button id="licClose" class="btn small">Close</button>
    </div>
    <div id="licStatus" class="muted" style="margin-bottom:8px">Loading…</div>
    <div class="sep"></div>

    <div class="section-title">Device ID</div>
    <div class="row" style="flex-wrap:wrap">
      <code id="devId" class="kbd">—</code>
      <button id="copyDev" class="btn small">Copy</button>
    </div>
     

    <div class="sep"></div>

    <div class="section-title">Activate with Serial</div>
    <input id="serialInput" class="input" type="text" placeholder="Paste serial (CF1-…)" />
    <div class="row" style="justify-content:flex-end">
      <button id="activateSerial" class="btn primary">Activate</button>
    </div>

    <div class="sep"></div>

    <div class="section-title">Or upload license file (.json)</div>
    <input id="licFile" class="input" type="file" accept=".json" />
    <div class="row" style="justify-content:flex-end">
      <button id="activateFile" class="btn">Upload & Activate</button>
    </div>
  </div>
</div>

<!-- Settings modal (Spotify keys + optional license key passthrough) -->
<div id="settingsModal" class="modal">
  <div class="modal-card">
    <div class="row-spread" style="margin-bottom:8px">
      <h3 style="margin:0">Settings</h3>
      <button id="settingsClose" class="btn small">Close</button>
    </div>
    <p class="muted" style="margin-top:0">Saved to <code>~/.curator-finder/config.json</code>.</p>

    <div class="section-title">Spotify Credentials</div>
    <input id="setupClientId" class="input" type="text" placeholder="Spotify Client ID" autocomplete="off" />
    <input id="setupClientSecret" class="input" type="password" placeholder="Spotify Client Secret" autocomplete="off" />

    <div class="section-title" style="margin-top:10px">License Key</div>
    <input id="setupLicense" class="input" type="text" placeholder="License Key (if you have one)" autocomplete="off" />

    <div class="row" style="justify-content:flex-end;gap:8px">
      <button id="settingsSave" class="btn primary">Save</button>
    </div>
  </div>
</div>

<script>
/* ----------------- State ----------------- */
function setRunning(on, msg){
  const btn = document.getElementById('runSearch');
  const bar = document.getElementById('runBar');
  if (btn) btn.disabled = !!on;
  if (bar) (on ? bar.classList.add('on') : bar.classList.remove('on'));
  if (msg) document.getElementById('runMsg').textContent = msg;
}
function setProgress(pct, text){
  const fill = document.getElementById('runFill');
  if (fill) fill.style.width = (pct || 0) + '%';
  if (text) document.getElementById('runMsg').textContent = text;
}

// ETA helpers
function fmtEta(sec){
  if (sec == null || isNaN(sec)) return '';
  sec = Math.max(0, Math.floor(sec));
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec%60;
  if (h)   return `~${h}h ${m}m`;
  if (m)   return `~${m}m ${s}s`;
  return `~${s}s`;
}
function lblProgress(pct, emails, target, etaSec, scanned){
  const parts = [`${pct}% • ${emails}/${target} emails`];
  if (typeof scanned === 'number') parts.push(`${scanned} scanned`);
  if (etaSec != null) parts.push(fmtEta(etaSec));
  return parts.join(' • ');
}

const $ = (sel)=>document.querySelector(sel);
let data = [];      // full curator records
let filtered = [];  // filtered view
const contactedKey = (r) => (r.playlist?.owner_handle || r.playlist?.owner_url || r.playlist?.owner_name || "").toLowerCase();
const contactedMap = JSON.parse(localStorage.getItem("contactedMap") || "{}");
function saveContacted(){ localStorage.setItem("contactedMap", JSON.stringify(contactedMap)); }

/* -------------- Status bar & license -------------- */
function badge(el, ok, label){
  el.textContent = label;
  el.className = "badge " + (ok ? "ok" : "err");
}
function fmtDate(ts){
  if(!ts) return "";
  const d = new Date(ts*1000);
  return d.toLocaleDateString();
}
async function refreshStatus(){
  try{
    const r = await fetch('/health', {cache:'no-store'});
    const h = await r.json();
    badge($('#svr'), true, 'Server OK');
    badge($('#sp'),  h.spotify.configured, h.spotify.configured ? 'Spotify OK' : 'Spotify Missing');
    const licOk = h.license.mode === 'disabled' ? true : h.license.ok;
    const licLbl = h.license.mode === 'disabled'
      ? 'License Off'
      : (licOk ? ('License OK' + (h.license.exp ? ' (exp ' + fmtDate(h.license.exp) + ')' : '')) : 'License Error');
    badge($('#lic'), licOk, licLbl);
    $('#ver').textContent = 'v' + h.version;

    // Auto-open Settings modal first time if Spotify missing
    if (!h.spotify.configured && !window._settingsPrompted) {
      window._settingsPrompted = true;
      showSettingsModal();
    }
  }catch(e){
    badge($('#svr'), false, 'Server Down');
    badge($('#sp'),  false, 'Spotify Unknown');
    badge($('#lic'), false, 'License Unknown');
  }
}
setInterval(refreshStatus, 3000);
refreshStatus();

/* License modal behavior */
function showLicModal(){ $('#licModal').style.display = 'block'; updateLicModal(); }
function hideLicModal(){ $('#licModal').style.display = 'none'; }
$('#manageLic').addEventListener('click', showLicModal);
$('#licClose').addEventListener('click', hideLicModal);

// Copy Device ID button
document.getElementById('copyDev')?.addEventListener('click', () => {
  const id = document.getElementById('devId')?.textContent || '';
  navigator.clipboard.writeText(id).then(()=>alert('Device ID copied'));
});

async function updateLicModal(){
  $('#licStatus').textContent = 'Loading…';
  try{
    const [hRes, dRes] = await Promise.all([fetch('/health'), fetch('/device-id')]);
    const h = await hRes.json();
    const d = await dRes.json();
    $('#devId').textContent = d.device_id || '(unknown)';
    const licOk = h.license.mode === 'disabled' ? true : h.license.ok;
    let msg = `Mode: ${h.license.mode}`;
    if(h.license.exp) msg += ` • Expires: ${fmtDate(h.license.exp)}`;
    msg += ` • Status: ${licOk ? 'OK' : (h.license.message || 'error')}`;
    $('#licStatus').textContent = msg;
  }catch(e){
    $('#licStatus').textContent = 'Failed to load license status.';
  }
}

async function showSettingsModal(){
  try{
    const r = await fetch('/config', {cache:'no-store'});
    if (r.ok){
      const c = await r.json();
      const id = document.getElementById('setupClientId');
      const secret = document.getElementById('setupClientSecret');
      id.placeholder = c.client_id_masked ? `Client ID (${c.client_id_masked})` : 'Spotify Client ID';
      secret.placeholder = c.client_secret_set ? '•••••••• (already set)' : 'Spotify Client Secret';
    }
  }catch(e){}
  document.getElementById('settingsModal').style.display = 'block';
}

/* Activate via serial */
$('#activateSerial').addEventListener('click', async ()=>{
  const serial = ($('#serialInput').value || '').trim();
  if(!serial){ alert('Paste a serial.'); return; }
  const btn = $('#activateSerial'); btn.disabled = true; btn.textContent = 'Activating…';
  try{
    const res = await fetch('/activate-serial', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ serial })
    });
    if(!res.ok){
      let msg = '';
      try { const j = await res.json(); msg = j.detail || JSON.stringify(j); }
      catch { msg = await res.text(); }
      throw new Error(msg);
    }
    alert('License activated!');
    await refreshStatus();
    await updateLicModal();
  }catch(e){
    alert('Activation error: ' + (e.message || e));
  }finally{
    btn.disabled = false; btn.textContent = 'Activate';
  }
});

/* Activate via JSON file */
$('#activateFile').addEventListener('click', async ()=>{
  const f = $('#licFile').files[0];
  if(!f){ alert('Choose a license .json file.'); return; }
  try{
    const txt = await f.text();
    const token = JSON.parse(txt);
    const res = await fetch('/activate', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ token })
    });
    if(!res.ok){
      let msg = '';
      try { const j = await res.json(); msg = j.detail || JSON.stringify(j); }
      catch { msg = await res.text(); }
      throw new Error(msg);
    }
    alert('License activated!');
    await refreshStatus();
    await updateLicModal();
  }catch(e){
    alert('Activation error: ' + (e.message || e));
  }
});

/* ---------------- Settings (Spotify keys) ---------------- */
function hideSettingsModal(){ $('#settingsModal').style.display = 'none'; }
$('#openSettings').addEventListener('click', showSettingsModal);
$('#settingsClose').addEventListener('click', hideSettingsModal);

$('#settingsSave').addEventListener('click', async ()=>{
  const client_id = ($('#setupClientId').value || '').trim();
  const client_secret = ($('#setupClientSecret').value || '').trim();
  const license_key = ($('#setupLicense').value || '').trim(); // optional

  if (!client_id || !client_secret){
    alert("Enter both Spotify Client ID and Secret.");
    return;
  }
  const btn = $('#settingsSave'); btn.disabled = true; btn.textContent = 'Saving…';
  try{
    const res = await fetch('/setup', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ client_id, client_secret, license_key })
    });
    if (!res.ok) {
      let msg = '';
      try { const j = await res.json(); msg = j.detail || JSON.stringify(j); }
      catch { msg = await res.text(); }
      throw new Error(msg);
    }
    hideSettingsModal();
    alert('Saved! You can now run searches.');
    await refreshStatus();
  }catch(e){
    alert('Setup error: ' + (e.message || e));
  }finally{
    btn.disabled = false; btn.textContent = 'Save';
  }
});

/* -------------- Utilities -------------- */
function matchesQuery(rec, q){
  if(!q) return true;
  q = q.toLowerCase();
  const pl = rec.playlist || {};
  const emails = (rec.contacts?.emails || []).map(e=>e.value).join(" ");
  const subs = (rec.contacts?.submission_links || []).join(" ");
  const hay = [pl.owner_name, pl.owner_handle, pl.name, pl.url, emails, subs, rec.source_query].join(" ").toLowerCase();
  return hay.includes(q);
}
function contactType(rec){
  const hasEmail = (rec.contacts?.emails || []).length > 0;
  const hasLink  = (rec.contacts?.submission_links || []).length > 0;
  return {hasEmail, hasLink};
}
function toCsv(rows){
  if(!rows.length) return "";
  const headers = Object.keys(rows[0]);
  const esc = (v)=>('"'+String(v ?? "").replace(/"/g,'""')+'"');
  return [headers.join(","), ...rows.map(r=>headers.map(h=>esc(r[h])).join(","))].join("\n");
}
async function copy(text){
  try{ await navigator.clipboard.writeText(text); }catch(e){ console.log(e); }
}
function mailtoHref(email, curator, playlist){
  const subjBase = `Submission: new track for ${playlist || "your playlist"}`;
  const bodyBase = `Hey ${curator || ""},

I’ve got a new track that fits your playlist "${playlist || ""}".
Short blurb here.
Streaming link: <your link>

Thanks!`;
  const enc = s => encodeURIComponent(s || "");
  const base = `mailto:${enc(email)}?subject=${enc(subjBase)}&body=${enc(bodyBase)}`;
  if (base.length <= 1800) return base;

  let body = bodyBase.slice(0, 1200) + "…";
  let subj = subjBase;
  let href = `mailto:${enc(email)}?subject=${enc(subj)}&body=${enc(body)}`;
  if (href.length <= 1800) return href;

  subj = subjBase.slice(0, 120) + "…";
  href = `mailto:${enc(email)}?subject=${enc(subj)}&body=${enc(body)}`;
  if (href.length <= 1800) return href;

  const minimal = `mailto:${enc(email)}?subject=${enc("Submission inquiry")}`;
  const full = `Subject: ${subjBase}\n\n${bodyBase}`;
  navigator.clipboard?.writeText(full).then(()=>{
    alert("Body was long for mailto. I copied the full message to your clipboard—paste it in your email.");
  }).catch(()=>{});
  return minimal;
}
function parseList(val){
  return (val || "").split(",").map(s => s.trim()).filter(Boolean);
}
function displayUrl(u){
  return u.replace(/^https?:\/\/(www\.)?/,'').slice(0,50) + (u.length>50 ? '…' : '');
}
function domainOf(u){
  try { return new URL(u).hostname.replace(/^www\./,''); }
  catch { return ""; }
}
function linkLabel(u){
  const d = domainOf(u);
  if (!d) return "Website";
  if (d.includes("instagram.com")) return "Instagram";
  if (d.includes("facebook.com"))  return "Facebook";
  if (d.includes("x.com") || d.includes("twitter.com")) return "X";
  if (d.includes("youtube.com") || d.includes("youtu.be")) return "YouTube";
  if (d.includes("tiktok.com"))   return "TikTok";
  if (d.includes("linktr.ee"))    return "Linktree";
  if (d.includes("beacons.ai"))   return "Beacons";
  if (d.includes("carrd.co"))     return "Carrd";
  if (d.includes("notion.so"))    return "Notion";
  if (d.includes("typeform.com")) return "Typeform";
  if (d.includes("jotform.com"))  return "Jotform";
  if (d.includes("tally.so"))     return "Tally";
  if (d.includes("airtable.com")) return "Airtable";
  if (d.includes("docs.google.com") && u.includes("/forms")) return "Google Form";
  return displayUrl("https://" + d);
}

/* -------------- Rendering -------------- */
function redraw(){
  const q = $("#q").value.trim();
  const hasVal = $("#has").value;
  const hideContacted = $("#hideContacted").checked;

  filtered = data.filter(r=>{
    if(!matchesQuery(r, q)) return false;
    const t = contactType(r);
    if(hasVal === "email" && !t.hasEmail) return false;
    if(hasVal === "link"  && !t.hasLink)  return false;
    if(hideContacted && contactedMap[contactedKey(r)]) return false;
    return true;
  });

  $("#stats").textContent = `showing ${filtered.length} of ${data.length} curators — `
    + `${data.filter(r=>contactType(r).hasEmail).length} with email, `
    + `${data.filter(r=>contactType(r).hasLink).length} with submission link`;

  const list = $("#list"); list.innerHTML = "";
  for(const r of filtered){
    const pl = r.playlist || {};
    const emails = r.contacts?.emails || [];
    const subs = r.contacts?.submission_links || [];
    const cKey = contactedKey(r);
    const isContacted = !!contactedMap[cKey];

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:600">${pl.owner_name || "(unknown curator)"} <span class="muted">•</span>
            <a href="${pl.url}" target="_blank" style="color:#cfd0ff;text-decoration:none">${pl.name || "(playlist)"} ↗</a>
          </div>
          <div class="muted" style="margin-top:2px">${r.source_query || ""}</div>
        </div>
        <div class="row">
          <span class="pill ${emails.length ? 'ok' : 'warn'}">${emails.length ? (emails.length+' email'+(emails.length>1?'s':'')) : 'no email'}</span>
          <span class="pill">${subs.length ? (subs.length+' link'+(subs.length>1?'s':'')) : 'no link'}</span>
        </div>
      </div>
      <table class="grid">
        <thead><tr><th>Contact</th><th>Context</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:10px">
        <label><input type="checkbox" class="checkbox mark" ${isContacted?'checked':''}/> marked as contacted</label>
      </div>
    `;
    list.appendChild(card);

    const tbody = card.querySelector("tbody");

    if (emails.length) {
      for (const e of emails) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${e.value ? `<code>${e.value}</code>` : '<span class="muted">—</span>'}</td>
          <td class="muted">${e.context || ""}</td>
          <td class="row-actions"></td>
        `;
        const actions = tr.querySelector(".row-actions");
        if (e.value) {
          const copyBtn = document.createElement("button");
          copyBtn.className = "btn copy";
          copyBtn.textContent = "Copy";
          copyBtn.addEventListener("click", ()=> copy(e.value));
          const mailA = document.createElement("a");
          mailA.className = "btn mail";
          mailA.textContent = "Mailto";
          mailA.href = mailtoHref(e.value, pl.owner_name, pl.name);
          actions.append(copyBtn, mailA);
        }
        tbody.appendChild(tr);
      }
    } else {
      if (subs.length) {
        for (const s of subs) {
          const label = linkLabel(s);
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${label}</td>
            <td class="muted">—</td>
            <td class="row-actions"></td>
          `;
          const actions = tr.querySelector(".row-actions");
          const a = document.createElement("a");
          a.className = "btn link";
          a.href = s;
          a.target = "_blank";
          a.rel = "noopener";
          a.textContent = "Open";
          actions.appendChild(a);
          tbody.appendChild(tr);
        }
      } else {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td><span class="muted">—</span></td><td class="muted">—</td><td class="row-actions"></td>`;
        tbody.appendChild(tr);
      }
    }

    card.querySelector(".mark").addEventListener("change", (ev)=>{
      if(ev.target.checked) contactedMap[cKey]=true; else delete contactedMap[cKey];
      saveContacted();
    });
  }
}

/* -------------- File Upload + Search -------------- */
$("#file").addEventListener("change", async (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const txt = await f.text();
  try{
    const json = JSON.parse(txt);
    data = Array.isArray(json) ? json : (json.results || []);
    redraw();
  }catch(e){ alert("Invalid JSON"); }
});

document.getElementById("q").addEventListener("input", redraw);
document.getElementById("has").addEventListener("change", redraw);
document.getElementById("hideContacted").addEventListener("change", redraw);

document.getElementById("exportCsv").addEventListener("click", ()=>{
  const rows = [];
  for(const r of filtered){
    const pl = r.playlist || {};
    const subs = (r.contacts?.submission_links || []).join(" ");
    const emails = r.contacts?.emails?.length ? r.contacts.emails : [{value:"", context:""}];
    for(const e of emails){
      rows.push({
        curator: pl.owner_name || "",
        handle: pl.owner_handle || "",
        playlist: pl.name || "",
        playlist_url: pl.url || "",
        email: e.value || "",
        email_context: e.context || "",
        submission_links: subs,
        source_query: r.source_query || "",
        contacted: contactedMap[(r.playlist?.owner_handle || r.playlist?.owner_url || r.playlist?.owner_name || "").toLowerCase()] ? "yes" : "no"
      });
    }
  }
  const headers = Object.keys(rows[0] || {a:1});
  const esc = (v)=>('"'+String(v ?? "").replace(/"/g,'""')+'"');
  const csv = [headers.join(","), ...rows.map(r=>headers.map(h=>esc(r[h])).join(","))].join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = (window.URL || URL).createObjectURL(blob);
  a.download = "curators_filtered.csv";
  a.click();
  (window.URL || URL).revokeObjectURL(a.href);
});

document.getElementById("clearLs").addEventListener("click", ()=>{
  Object.keys(contactedMap).forEach(k=>delete contactedMap[k]);
  saveContacted(); redraw();
});

/* ---- Run Search (same-origin backend) ---- */
async function runSearch(){
  setRunning(true, "Starting…");
  setProgress(0, "0%");

  const artists  = parseList(document.getElementById("artists").value);
  const keywords = parseList(document.getElementById("keywords").value);
  const genres   = parseList(document.getElementById("genres").value);
  const target   = parseInt(document.getElementById("target").value || "50", 10) || 50;

  try{
    const res = await fetch("/search", {
      method: "POST",
      headers: {"Content-Type":"application/json", "Accept":"application/x-ndjson"},
      cache: "no-store",
      body: JSON.stringify({ artists, keywords, genres, target, save:false })
    });

    // Fallback path if stream not supported
    if (!res.body || !res.body.getReader){
      const txt = await res.text();
      const out = JSON.parse((txt || "").trim() || "{}");
      if (!res.ok || out.error) throw new Error(out.error || "Load failed");
      data = Array.isArray(out) ? out : (out.results || []);
      redraw();
      setProgress(100, "Done");
      setRunning(false, "Done");
      return;
    }

    // Stream NDJSON
    const reader = res.body.getReader();
    const dec = new TextDecoder();
    let buf = "";
    let gotFinal = false;

    // initialize label with ETA/scanned placeholders
    setProgress(0, lblProgress(0, 0, target, null, 0));

    while (true){
      const {value, done} = await reader.read();
      if (done) break;
      buf += dec.decode(value, {stream:true});
      const lines = buf.split("\n");
      buf = lines.pop(); // keep partial

      for (const raw of lines){
        const line = raw.trim();
        if (!line) continue;
        let msg;
        try { msg = JSON.parse(line); } catch { continue; }

        if (msg.type === "progress"){
          const pct = Math.max(0, Math.min(100, msg.pct|0));
          const emails  = msg.emails ?? 0;
          const tgt     = msg.target ?? target;
          const eta     = (typeof msg.eta_sec === 'number') ? msg.eta_sec : null;
          const scanned = msg.scanned;
          setProgress(pct, lblProgress(pct, emails, tgt, eta, scanned));
        } else if (msg.type === "final"){
          const payload = msg.payload || {};
          data = Array.isArray(payload) ? payload : (payload.results || []);
          redraw();
          setProgress(100, lblProgress(100, payload.unique_emails ?? 0, target, 0, payload.count_curators));
          gotFinal = true;
        } else if (msg.type === "error"){
          throw new Error(msg.detail || "Search failed");
        }
      }
    }

    if (!gotFinal){
      // try parse any leftover as final
      const tail = (buf || "").trim();
      if (tail){
        try{
          const msg = JSON.parse(tail);
          if (msg.type === "final"){
            const payload = msg.payload || {};
            data = Array.isArray(payload) ? payload : (payload.results || []);
            redraw();
            setProgress(100, lblProgress(100, payload.unique_emails ?? 0, target, 0, payload.count_curators));
          } else if (msg.type === "error"){
            throw new Error(msg.detail || "Search failed");
          }
        }catch(e){}
      }
    }

    setRunning(false, "Done");
  }catch(e){
    alert("Search error: " + (e.message || e));
    setRunning(false, "Error");
  }
}

document.getElementById("runSearch").addEventListener("click", runSearch);
</script>
</body>
</html>
